### 6. Получение чатов и создание ключей чата

#### Создание чата:
- При активации профиля (подтверждение номера), если номер контакта есть в базе;
  - Для системного контакта "Командор" ключи создаются на сервере, для "Избранного" и всех остальных только на клиенте;
- При передаче массива номеров с клиента.

#### Статусы чата:
- `new` - Новый. Без ключей;
- `wait` - Ожидает синхронизации. У чата есть ключи, но нет ключа для текущего сертификата;
- `sync` - Синхронизированный. Есть ключи на все сертификаты.

### Логика получения чатов

1. При инициализации приложения загружаем все текущие чаты без передачи списка номеров;
2. Передаем список номеров (новые контакты или введенный номер), в результате получаем список созданных чатов;
3. Если номера не найдены в результате будет пустой массив;
4. Если новые чаты получены добавляем в локальное хранилище объекты чатов.

### 6.1. Создание ключей чата (синхронизация)

Для чата со статусом `new` без ключей `chats.chatKey = null` и минимум одним сертификатом контакта `chats.certificates`,
необходимо сгенерировать новый ключ чата, экспортировать ключ на все сертификаты, и подписать экспортированные ключи 
текущим сертификатом профиля.

Для чата со статусом `wait` с ключом чата `chats.chatKey` и минимум одним сертификатом контакта `chats.certificates`,
необходимо экспортировать ключ на все сертификаты контакта, подписать ключи текущим сертификатом профиля.

Зарегистрировать ключи выполнив запрос: [/api/v2/chatsKeys/](https://api.komandor.app/docs/static/index.html#/Chats/post_api_chatKeys_)

```http request
POST https://api.komandor.app/api/v2/chatsKeys/
Authorization: Bearer JWT_TOKEN
```
```json
{
  "keys": [{
    "chatId": "(string) Идентификатор чата",
    "cid": "(string) Идентификатор сертификата",
    "pid": "(string) Идентификатор профиля",
    "key": "(base64) Зашифрованный (экспортированный) ключ",
    "sign": "(base64) Подпись зашифрованного ключа"
  }]
}
```

На сервере проверяется подпись `sign` ключа `key`, если подпись совпадает — регистрируем ключ чата.

При успешной регистрации на клиенте заново запрашиваем все чаты запросом: [/api/v2/chats/](https://api.komandor.app/docs/static/index.html#/Chats/post_api_chats_)
и обновляется локальное хранилище.

### 6.2. Получение списка чатов

Для получения списка созданных чатов необходимо выполнить запрос: [/api/v2/chats/](https://api.komandor.app/docs/static/index.html#/Chats/post_api_chats_)

```http request
GET https://api.komandor.app/api/v2/chats/
Authorization: Bearer JWT_TOKEN
```

Если передан массив номеров `phones` то у пользователя будут добавлены новые номера и созданы чаты без ключей.

Для чатов со статусами `new` или `wait` может быть передан массив `waitList` с идентификаторами профилей и сертификатов
для синхронизации ключей. 

Для статуса `new` создаем новый ключ, для `wait` импортируем ключ `chatKey` (если есть) и экспортируем ключ
на все сертификаты `waitList.certificate`. Если для `wait` нет ключа `chatKey` то ожидается синхронизация под предыдущим
сертификатом или со стороны контакта.

Структура ответа:

```json
{
  "success": "(boolean)",
  "data": [
    {
      "id": "(string) ID чата",
      "profileName": "(string) ФИО контакта",
      "profileCompany": "(string) Название организации|Индивидуальный предприниматель",
      "profileCompanyId": "(string) Идентификатор организации для группировки чатов",
      "profileTitle": "(string) Должность",
      "profilePhone": "(string) Номер телефона в формате 79XXXXXXXXX",
      "profilePhoto": "(base64) Фото профиля",
      "profileType": "(number) Тип профиля контакта: 0 - SYS, 1 - FL, 2 - IP, 3 - UL",
      "profileVerified": "(boolean) Признак дополнительной верификации профиля",
      "certificates": [{
        "pid": "(string) ID профиля контакта",
        "cid": "(string) ID сертификата контакта (для проверки подписи)",
        "certificate": "(base64) Сертификат PEM",
        "hash": "(string) Хэш сертификата"
      }],
      "chatType": "(number) Тип чата: 0 - личный/избранное, 1 - группа, 2 - канал",
      "chatName": "(string) Название группы или канала",
      "chatFavorites": "(boolean) Признак избранное",
      "chatKey": {
        "id": "(string) ID ключа",
        "key": "(base64) Сессионный ключ"
      },
      "waitList": [{
        "pid": "(string) ID профиля",
        "cid": "(string) ID сертификата",
        "certificate": "(base64) Сертификат PEM",
        "hash": "(string) Хэш сертификата"
      }],
      "lastMessageText": "(base64) Последнее сообщение",
      "lastMessageStatus": "(number) Статус сообщения",
      "lastMessageTime": "(timestamp) Время статуса",
      "unreadMessages": "(number) Количество непрочитанных сообщений",
      "status": "(string) Статус чата: new, wait, sync"
    }
  ]
}
```

_Если чат со статусом `new/wait`, то чат в режиме ожидания синхронизации (выключен). В такой чат нельзя писать и читать 
сообщения._
