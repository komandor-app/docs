### 7. Создание, получение и отправка сообщений в чат

### Получение списка сообщений

По умолчанию для чата `chatId` или папки `folderId` возвращаются последние 20 сообщений. 

Если передан `folderId` будут возвращены только сообщения из папки, в этом случае параметр `chatId` не передается.

Если переданы `messageId` и `rel = 'prev|next'` будут возвращены предыдущие или последующие сообщения от указанного 
идентификатора.

Если передан `type = 'file'` буду возвращены только сообщения с файлами.

```http request
POST https://api.komandor.app/api/v2/messages/
Authorization: Bearer JWT_TOKEN
Content-Type: application/json
```
```json
{
  "chatId?": "(string) ID чата",
  "folderId?": "(string) ID папки",
  "messageId?": "(string) ID сообщения",
  "rel?": "(string) Направления запроса: prev|next",
  "type?": "(string) Тип сообщения: file"
}
```

[swagger](https://api.komandor.app/docs/static/index.html#/Messages/post_api_messages_)

В результате получаем массив объектов сообщений

```json
[{
  "id": "(string) ID сообщения",
  "lastId": "(string) ID последнего сообщения",
  "timestamp": "(timestamp) Врем создания сообщения для сортировки",
  "pid": "(string) ID профиля отправителя",
  "cid": "(string) ID сертификата отправителя",
  "chatId": "(string) ID чата",
  "keyId": "(string) ID ключа",
  "folderId": "(string) ID папки",
  "type": "(string) Тип сообщения: text/file/etc",
  "user": "(string) ФИО отправителя",
  "text": "(base64) Зашифрованное текстовое сообщение или имя файла",
  "textSign": "(base64) Простая подпись для text",
  "fileId": "(uuid) ID файла в хранилище",
  "fileSize": "(number) Размер файла в байтах",
  "fileSign": "(base64) CMS подпись для файла",
  "status": "(number) Статус: 0 - новый, 1 - отправлен, 2 - доставлен, 3 - прочитан",
  "statusTime": "(timestamp) Время последнего статуса"
}]
```

### Отправка сообщения

Сообщения бывают (пока) двух типов: текст или файл. Перед отправкой сообщения его необходимо зашифровать на ключе чата.

Текстовые сообщения без файлов отправляем сразу со статусом "Доставлен". Такое сообщение сразу будет доступно контакту.

Сообщение с файлом отправляем со статусом "Новый", и только после загрузки файла в хранилище обновляем статус сообщения 
на "Доставлен". 

После обновления статуса сообщения с "Новый" на "Доставлен" обновляем `timestamp` сообщения, отправляем сообщение в
сокет и пуш для получения полного сообщения контактом.

```http request
POST https://api.komandor.app/api/v2/sendMessage/
Authorization: Bearer JWT_TOKEN
Content-Type: application/json
```
```json
{
  "lastId": "(string) ID последнего сообщения",
  "chatId": "(string) ID чата",
  "keyId": "(string) ID ключа",
  "type": "(string) Тип сообщения: text/file/etc",
  "text": "(base64) Зашифрованное текстовое сообщение или имя файла",
  "textSign": "(base64) Простая подпись для text",
  "fileId": "(string) ID файла в хранилище",
  "fileSize": "(number) Размер файла в байтах",
  "fileSign": "(base64) CMS подпись для файла",
  "status": "(number) 0 - новый (черновик), 1 - отправлен, 2 - доставлен, 3 - прочитан"
}
```

[swagger](https://api.komandor.app/docs/static/index.html#/Messages/post_api_sendMessage_)

В результате получаем полный объект сообщения

```json
{
  "id": "(string) ID сообщения",
  "lastId": "(string) ID последнего сообщения",
  "timestamp": "(timestamp) Врем создания сообщения для сортировки",
  "pid": "(string) ID профиля отправителя",
  "cid": "(string) ID сертификата отправителя",
  "chatId": "(string) ID чата",
  "keyId": "(string) ID ключа",
  "type": "(string) Тип сообщения: text/file/etc",
  "user": "(string) ФИО отправителя",
  "text": "(base64) Зашифрованное текстовое сообщение или имя файла",
  "textSign": "(base64) Простая подпись для text",
  "fileId": "(uuid) ID файла в хранилище",
  "fileSize": "(number) Размер файла в байтах",
  "fileSign": "(base64) CMS подпись для файла",
  "status": "(number) Статус: 0 - новый, 1 - отправлен, 2 - доставлен, 3 - прочитан",
  "statusTime": "(timestamp) Время последнего статуса"
}
```

Уведомление контакту в сокет

```json
{
  "event": "message",
  "data": {}
}
```
- `data` - объект сообщения

На клиенте подключаемся по URL:

wss://api.komandor.app/centrifugo/connection/websocket

### Отправка файла

Для загрузки файла необходимо получить подписанную ссылку на хранилище и идентификатор файла

```http request
POST https://api.komandor.app/api/v2/fileUploadInfo/
Authorization: Bearer JWT_TOKEN
Content-Type: application/json
```
```json
{
  "chatId": "(string) ID чата"
}
```

Ответ:

```json
{
  "id": "(string) ID файла",
  "url": "(string) Подписанная ссылка для загрузка файла в хранилище"
}
```

Отправить зашифрованный файл в бинарном виде по полученной ссылке:

```http request
PUT https://komandor.storage.yandexcloud.net/{chatId}/{fileId}?Content-Type=application%2Fx-www-form-urlencoded&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=VFORn1C9iOlKmbfrpQRr%2F20210209%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210209T082216Z&X-Amz-Expires=3600&X-Amz-Signature=6dc4213fb959b5eda8e13cbb7633219492629bc1dd2290ba82b818f659e4ef07&X-Amz-SignedHeaders=host
Content-Type: application/x-www-form-urlencoded
```

### Загрузка файла

Прямое скачивание зашифрованного файла из хранилища. Параметры `chatId` и `fileId` являются уникальным идентификатором файла.

```http request
GET https://gateway.komandor.app/files/{chatId}/{fileId}
```
- `chatId` - ID чата
- `fileId` - ID файла

